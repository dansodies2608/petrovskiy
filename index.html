<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Для Telegram WebApp -->
    <meta name="telegram-web-app-bot-domain" content="dansodies2608.github.io">
    <meta name="telegram-web-app-platform" content="desktop mobile">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self' https://*.telegram.org;
      script-src 'self' 'unsafe-inline' https://www.gstatic.com;
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
      font-src 'self' https://fonts.gstatic.com;
      img-src 'self' data: https://*;
      connect-src 'self' https://*.googleapis.com https://*.firebaseio.com;
      frame-src 'self' https://telegram.org;
    ">
    
    <title>Автомобильный дашборд</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/style.css?v=0.5">
    
    <style>
      /* Временные стили для отладки */
      #debug-console {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 120px;
        overflow: auto;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 8px;
        font-family: monospace;
        font-size: 12px;
        z-index: 9999;
        display: none;
      }
    </style>
</head>

<body>
    <div class="dashboard">
        <div class="header">
            <h1>НА</h1>
            <div class="date-selector">
                <select id="month-select">
                    <option value="1">Январь</option>
                    <option value="2">Февраль</option>
                    <option value="3">Март</option>
                    <option value="4">Апрель</option>
                    <option value="5">Май</option>
                    <option value="6">Июнь</option>
                    <option value="7">Июль</option>
                    <option value="8">Август</option>
                    <option value="9">Сентябрь</option>
                    <option value="10">Октябрь</option>
                    <option value="11">Ноябрь</option>
                    <option value="12">Декабрь</option>
                </select>

                <select id="year-select">
                    <!-- Годы заполнятся скриптом -->
                </select>

                <button id="apply-date">Применить</button>
            </div>
        </div>

        <div class="tabs">
            <button data-count="0" class="tab-btn active">НА</button>
            <button data-count="1" class="tab-btn">АСП</button>
            <button data-count="2" class="tab-btn">СТС</button>
            <button data-count="3" class="tab-btn">МКЦ</button>
            <button data-count="4" class="tab-btn">БАЛАНС</button>
        </div>

        <!-- Вкладка "Новые авто" -->
        <div class="tab-content active" id="new-cars-tab">
            <div class="cards-container">
                <!-- Карточки будут создаваться динамически -->
            </div>
        </div>

        <!-- Вкладка "Авто с пробегом" -->
        <div class="tab-content" id="used-cars-tab">
            <div class="cards-container"></div>
        </div>

        <div class="tab-content" id="service-tab"></div>
        <!-- Новая вкладка МКЦ -->
        <div class="tab-content" id="mkc-tab"></div>
        <!-- Вкладка "Баланс" -->
        <div class="tab-content" id="balance-tab"></div>
    </div>

    <!-- Отладочная консоль -->
    <div id="debug-console"></div>

    <!-- Скрипт инициализации Telegram WebApp -->
    <script>
      // Функция для отладки
      function debugLog(message) {
        console.log(message);
        const debugConsole = document.getElementById('debug-console');
        if (debugConsole) {
          debugConsole.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
          debugConsole.scrollTop = debugConsole.scrollHeight;
        }
      }
      
      // Показать отладочную консоль при долгом нажатии
      document.addEventListener('longpress', () => {
        const debugConsole = document.getElementById('debug-console');
        debugConsole.style.display = debugConsole.style.display === 'none' ? 'block' : 'none';
      });
      
      debugLog('Начало загрузки страницы');
    </script>

    <!-- Динамическая загрузка скриптов с обработкой ошибок -->
    <script>
      function loadScript(src, integrity) {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = src;
          if (integrity) script.integrity = integrity;
          script.crossOrigin = 'anonymous';
          script.onload = () => {
            debugLog(`Скрипт загружен: ${src}`);
            resolve();
          };
          script.onerror = (err) => {
            debugLog(`Ошибка загрузки скрипта ${src}: ${err}`);
            reject(err);
          };
          document.body.appendChild(script);
        });
      }

      // Последовательная загрузка скриптов
      async function loadAllScripts() {
        try {
          await loadScript('https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js');
          await loadScript('https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js');
          await loadScript(`assets/app.js?v=${Date.now()}`);
          
          debugLog('Все скрипты успешно загружены');
          
          // Инициализация Telegram WebApp
          if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            debugLog('Telegram WebApp инициализирован');
            
            // Настройки для мобильной версии
            if (Telegram.WebApp.isMobile) {
              document.documentElement.style.fontSize = '14px';
              document.querySelector('.tabs').style.position = 'fixed';
            }
          }
        } catch (error) {
          debugLog(`Критическая ошибка: ${error.message}`);
          alert('Ошибка загрузки приложения. Пожалуйста, попробуйте позже.');
        }
      }

      // Запуск загрузки после полной загрузки DOM
      document.addEventListener('DOMContentLoaded', loadAllScripts);
    </script>
</body>
</html>
